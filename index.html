<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Météo Vision 3D Pro - Portail Complet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #020617;
            min-height: 100vh;
            color: white;
            margin: 0;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 20px;
        }

        #three-canvas-container {
            width: 100%;
            height: 480px;
            border-radius: 1.5rem;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .nav-link {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
        }

        .nav-link.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            font-weight: 700;
        }

        .page-content {
            display: none; /* Masqué par défaut */
            animation: fadeIn 0.4s ease-out;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type="range"] {
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
        }

        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="pb-10">
    <!-- Barre de Navigation -->
    <nav class="sticky top-0 z-[100] border-b border-white/10 bg-slate-950/80 backdrop-blur-md px-6 py-4">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg shadow-lg">
                    <i data-lucide="cloud-sun" class="text-white w-5 h-5"></i>
                </div>
                <span class="font-black text-lg tracking-tighter">METEO<span class="text-blue-500">3D</span></span>
            </div>
            
            <div class="flex items-center gap-2 text-sm font-semibold text-slate-400">
                <a onclick="switchPage('home')" id="nav-home" class="nav-link active hover:text-white">Dashboard 3D</a>
                <a onclick="switchPage('details')" id="nav-details" class="nav-link hover:text-white">Prévisions Hebdo</a>
                <a onclick="switchPage('about')" id="nav-about" class="nav-link hover:text-white">À propos</a>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 mt-8">
        
        <!-- SECTION RECHERCHE -->
        <div id="search-container" class="shadow-2xl bg-slate-900 border border-slate-700/50 rounded-2xl p-6 mb-8">
            <form id="searchForm" class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-grow w-full relative">
                    <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-5 h-5"></i>
                    <input type="text" id="cityInput" 
                        placeholder="Rechercher une ville..." 
                        class="w-full pl-12 pr-6 py-3 rounded-xl bg-slate-800 text-white border border-slate-700 font-bold outline-none focus:border-blue-500 transition-colors">
                </div>
                <button type="submit" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold px-10 py-3 rounded-xl transition-all shadow-lg shadow-blue-600/20">
                    EXPLORER
                </button>
            </form>
            <p id="searchStatus" class="text-red-400 text-xs mt-2 font-bold opacity-0 transition-opacity">Ville introuvable</p>
        </div>

        <!-- PAGE : DASHBOARD 3D (HOME) -->
        <main id="page-home" class="page-content active space-y-8">
            <div class="relative">
                <div id="three-canvas-container" class="border border-white/5 shadow-2xl">
                    <div class="absolute top-6 right-6 z-10 text-right pointer-events-none">
                        <h2 id="cityName" class="text-5xl font-black uppercase tracking-tighter drop-shadow-2xl">--</h2>
                        <div class="mt-4 inline-block bg-black/40 backdrop-blur-md border border-white/10 px-5 py-2 rounded-2xl shadow-2xl text-right">
                            <p id="weatherLiteral" class="text-xl font-black text-white tracking-wide">--</p>
                            <p id="currentDate" class="text-blue-300 text-[10px] font-black uppercase tracking-widest mt-1"></p>
                        </div>
                    </div>
                    <div id="loadingOverlay" class="absolute inset-0 z-20 bg-slate-950 flex flex-col items-center justify-center transition-opacity duration-300">
                        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>

                <div class="absolute bottom-6 left-1/2 -translate-x-1/2 w-[92%] z-20 glass-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 id="sliderTimeLabel" class="text-3xl font-black tabular-nums">12:00</h3>
                            <p id="sliderDateLabel" class="text-xs font-bold text-blue-400 uppercase tracking-widest">Aujourd'hui</p>
                        </div>
                        <div class="text-right">
                            <p id="sliderTempLabel" class="text-3xl font-black">--°C</p>
                            <p id="sliderDescLabel" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">--</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="playPauseBtn" onclick="togglePlay()" class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-full flex-shrink-0 transition-all active:scale-95 shadow-lg shadow-blue-500/40">
                            <i data-lucide="play" class="w-5 h-5 ml-0.5"></i>
                        </button>
                        <input type="range" id="timeSlider" min="0" max="167" value="0" class="w-full cursor-pointer">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 glass-card">
                    <h3 class="text-xs font-black uppercase text-slate-500 mb-4 tracking-widest">Évolution Température</h3>
                    <div class="h-64 overflow-x-auto custom-scrollbar">
                        <div style="min-width: 2000px; height: 100%;">
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="glass-card flex justify-between items-center border-l-4 border-blue-500">
                        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Vent</span>
                        <span id="windSpeed" class="text-2xl font-black">-- km/h</span>
                    </div>
                    <div class="glass-card flex justify-between items-center border-l-4 border-cyan-500">
                        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Humidité</span>
                        <span id="humidity" class="text-2xl font-black">-- %</span>
                    </div>
                    <div id="forecastContainerHome" class="glass-card flex-grow overflow-y-auto max-h-[160px] custom-scrollbar text-xs"></div>
                </div>
            </div>
        </main>

        <!-- PAGE : PRÉVISIONS DÉTAILLÉES -->
        <main id="page-details" class="page-content space-y-8">
            <h2 class="text-3xl font-extrabold flex items-center gap-3">
                <i data-lucide="list" class="text-blue-500"></i> Prévisions sur 7 jours
            </h2>
            <div class="grid grid-cols-1 gap-4" id="detailedForecastList"></div>
        </main>

        <!-- PAGE : À PROPOS -->
        <main id="page-about" class="page-content">
            <div class="glass-card max-w-3xl mx-auto space-y-6">
                <h2 class="text-3xl font-black text-blue-400">À propos de MétéoVision 3D</h2>
                <div class="space-y-4 text-slate-300 leading-relaxed">
                    <p>Cette application est une simulation atmosphérique avancée utilisant les dernières technologies du web.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                        <div class="bg-white/5 p-5 rounded-2xl">
                            <h4 class="font-bold text-white mb-2 flex items-center gap-2">
                                <i data-lucide="box" class="w-4 h-4 text-blue-500"></i> Three.js
                            </h4>
                            <p class="text-xs">Moteur 3D gérant les nuages volumétriques, les astres et les effets de précipitations.</p>
                        </div>
                        <div class="bg-white/5 p-5 rounded-2xl">
                            <h4 class="font-bold text-white mb-2 flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i> GPU Shaders
                            </h4>
                            <p class="text-xs">Le ciel est rendu par un shader FBM personnalisé pour des dégradés et une couverture nuageuse fluide.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-20 text-center space-y-4">
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10 text-[10px] font-bold uppercase tracking-widest text-slate-400">
                <i data-lucide="eye" class="w-3 h-3"></i>
                <span>Visites : <span id="visit-counter" class="text-blue-400">...</span></span>
            </div>
            <p class="opacity-30 text-[10px] font-bold uppercase tracking-[0.4em]">
                Propulsé par la Vision Artificielle • 2024
            </p>
        </footer>
    </div>

    <!-- Scripts Firebase (Compteur de visites) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isIncremented = false;

        async function initVisitCounter() {
            try {
                // RÈGLE 3 : Authentification d'abord
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Attendre que l'état d'auth soit propagé
                onAuthStateChanged(auth, async (user) => {
                    if (!user) return;

                    // RÈGLE 1 : Chemin Firestore strict
                    const visitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'global');
                    
                    if (!isIncremented) {
                        isIncremented = true;
                        try {
                            // Incrémenter de manière atomique (crée le doc s'il n'existe pas avec merge)
                            await setDoc(visitDocRef, { 
                                visitCount: increment(1) 
                            }, { merge: true });
                        } catch (e) {
                            console.error("Erreur incrementation:", e);
                        }
                    }

                    // Écouter les changements en temps réel avec gestion d'erreur
                    onSnapshot(visitDocRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const count = snapshot.data().visitCount;
                            document.getElementById('visit-counter').textContent = count.toLocaleString('fr-FR');
                        }
                    }, (error) => {
                        console.error("Erreur snapshot:", error);
                    });
                });

            } catch (err) {
                console.error("Erreur Firebase:", err);
                document.getElementById('visit-counter').textContent = "Hors ligne";
            }
        }

        initVisitCounter();
    </script>

    <script>
        // --- LOGIQUE DE NAVIGATION ---
        function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.getElementById('nav-' + pageId).classList.add('active');
            lucide.createIcons();
            if(pageId === 'home' && weatherData) updateChart();
        }

        // --- MOTEUR MÉTÉO ET 3D ---
        let scene, camera, renderer, skyDome, skyUniforms;
        let stars, sunSprite, moonMesh, lightning, rainLines, snowPoints;
        let cloudsGroup, cloudMat, sunLight;
        let currentWeather = { isSnow: false, isRain: false, isStorm: false };
        let weatherData = null;
        let chartInstance = null;
        let isPlaying = false;
        let playInterval = null;
        const container = document.getElementById('three-canvas-container');
        const input = document.getElementById('cityInput');

        const skyVertexShader = `varying vec2 vUv; varying vec3 vWorldPosition; void main() { vUv = uv; vec4 worldPosition = modelMatrix * vec4(position, 1.0); vWorldPosition = worldPosition.xyz; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
        const skyFragmentShader = `uniform float uTime; uniform vec3 uColorTop; uniform vec3 uColorBottom; uniform float uCloudCover; uniform vec3 uCloudColor; varying vec2 vUv; varying vec3 vWorldPosition; float random(in vec2 st) { return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123); } float noise(in vec2 st) { vec2 i = floor(st); vec2 f = fract(st); float a = random(i); float b = random(i + vec2(1.0, 0.0)); float c = random(i + vec2(0.0, 1.0)); float d = random(i + vec2(1.0, 1.0)); vec2 u = f * f * (3.0 - 2.0 * f); return mix(a, b, u.x) + (c - a)* u.y * (1.0 - u.x) + (d - b) * u.x * u.y; } float fbm(in vec2 st) { float v = 0.0; float a = 0.5; vec2 shift = vec2(100.0); mat2 rot = mat2(cos(0.5), sin(0.5), -sin(0.5), cos(0.50)); for (int i = 0; i < 5; ++i) { v += a * noise(st); st = rot * st * 2.0 + shift; a *= 0.5; } return v; } void main() { float h = normalize(vWorldPosition).y; h = clamp(h, 0.0, 1.0); vec3 skyColor = mix(uColorBottom, uColorTop, max(pow(h, 0.6), 0.0)); vec2 cloudUV = vUv * 6.0; cloudUV.x += uTime * 0.015; cloudUV.y += uTime * 0.005; float q = fbm(cloudUV); float cloudNoise = fbm(cloudUV + q + uTime*0.01); float cloudAlpha = smoothstep(1.0 - uCloudCover, 1.0, cloudNoise); vec3 finalColor = mix(skyColor, uCloudColor, cloudAlpha * 0.95); gl_FragColor = vec4(finalColor, 1.0); }`;

        function createSunTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d'); const grad = ctx.createRadialGradient(64, 64, 5, 64, 64, 64);
            grad.addColorStop(0, 'rgba(255, 255, 255, 1)'); grad.addColorStop(1, 'rgba(255, 200, 100, 0)');
            ctx.fillStyle = grad; ctx.fillRect(0,0,128,128); return new THREE.CanvasTexture(canvas);
        }

        function createCloudTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d'); for(let i=0; i<100; i++) { const x = 256 + (Math.random()-0.5)*250; const y = 256 + (Math.random()-0.5)*150; const r = 40 + Math.random()*80; const grad = ctx.createRadialGradient(x, y, 0, x, y, r); grad.addColorStop(0, 'rgba(255,255,255,0.08)'); grad.addColorStop(1, 'rgba(255,255,255,0)'); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill(); }
            return new THREE.CanvasTexture(canvas);
        }

        function init3D() {
            scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(container.clientWidth, container.clientHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); container.appendChild(renderer.domElement);
            skyUniforms = { uTime: { value: 0 }, uColorTop: { value: new THREE.Color(0x1e488f) }, uColorBottom: { value: new THREE.Color(0x8cb4f5) }, uCloudCover: { value: 0.2 }, uCloudColor: { value: new THREE.Color(0xffffff) } };
            skyDome = new THREE.Mesh(new THREE.SphereGeometry(1000, 32, 32), new THREE.ShaderMaterial({ vertexShader: skyVertexShader, fragmentShader: skyFragmentShader, uniforms: skyUniforms, side: THREE.BackSide }));
            scene.add(skyDome); sunLight = new THREE.DirectionalLight(0xffffff, 1.2); scene.add(sunLight); scene.add(new THREE.AmbientLight(0x404055, 0.6));
            cloudsGroup = new THREE.Group(); cloudMat = new THREE.MeshLambertMaterial({ map: createCloudTexture(), transparent: true, depthWrite: false, opacity: 0, color: 0xffffff });
            const cloudGeo = new THREE.PlaneGeometry(200, 200);
            for(let i=0; i<120; i++) { const pivot = new THREE.Group(); pivot.position.set((Math.random()-0.5)*1500, 50 + Math.random()*80, (Math.random()-0.5)*1500); const mesh = new THREE.Mesh(cloudGeo, cloudMat); mesh.rotation.z = Math.random()*Math.PI*2; mesh.scale.set(0.5+Math.random()*1.5, 0.5+Math.random()*1.5, 1); pivot.add(mesh); pivot.userData = { speed: 0.05 + Math.random()*0.1 }; cloudsGroup.add(pivot); }
            scene.add(cloudsGroup); sunSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: createSunTexture(), blending: THREE.AdditiveBlending })); sunSprite.scale.set(150, 150, 1); scene.add(sunSprite); moonMesh = new THREE.Mesh(new THREE.SphereGeometry(8, 32, 32), new THREE.MeshBasicMaterial({ color: 0xeeeeee })); scene.add(moonMesh);
            const sGeo = new THREE.BufferGeometry(); const sPos = new Float32Array(4000*3); for(let i=0; i<sPos.length; i++) sPos[i] = (Math.random()-0.5)*1800; sGeo.setAttribute('position', new THREE.BufferAttribute(sPos, 3)); stars = new THREE.Points(sGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.8 })); scene.add(stars);
            const rainGeo = new THREE.BufferGeometry(); const rainPos = new Float32Array(3000*6);
            for(let i=0; i<3000; i++) { const x = (Math.random()-0.5)*600; const y = Math.random()*600; const z = (Math.random()-0.5)*600; rainPos[i*6] = x; rainPos[i*6+1] = y; rainPos[i*6+2] = z; rainPos[i*6+3] = x; rainPos[i*6+4] = y-15; rainPos[i*6+5] = z; }
            rainGeo.setAttribute('position', new THREE.BufferAttribute(rainPos, 3)); rainLines = new THREE.LineSegments(rainGeo, new THREE.LineBasicMaterial({ color: 0x88ccff, transparent: true, opacity: 0 })); scene.add(rainLines);
            const snowGeo = new THREE.BufferGeometry(); const snowPos = new Float32Array(2000*3); for(let i=0; i<2000; i++) { snowPos[i*3] = (Math.random()-0.5)*600; snowPos[i*3+1] = Math.random()*600; snowPos[i*3+2] = (Math.random()-0.5)*600; }
            snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3)); snowPoints = new THREE.Points(snowGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 1.5, transparent: true, opacity: 0 })); scene.add(snowPoints);
            lightning = new THREE.PointLight(0xffffff, 0, 1500); lightning.position.set(0, 150, 0); scene.add(lightning); camera.position.set(0, 20, 120); camera.lookAt(0, 60, 0);

            function animate() {
                requestAnimationFrame(animate); const time = Date.now() * 0.001; skyUniforms.uTime.value = time; stars.rotation.y += 0.00005;
                if(rainLines.material.opacity > 0) { const p = rainLines.geometry.attributes.position.array; for(let i=1; i<p.length; i+=6) { p[i] -= 8; p[i+3] -= 8; if(p[i] < -50) { const ny = 400 + Math.random()*100; p[i] = ny; p[i+3] = ny - 15; } } rainLines.geometry.attributes.position.needsUpdate = true; }
                if(snowPoints.material.opacity > 0) { const sp = snowPoints.geometry.attributes.position.array; for(let i=1; i<sp.length; i+=3) { sp[i] -= 1.5; sp[i-1] += Math.sin(time + i)*0.03; if(sp[i] < -50) sp[i] = 400; } snowPoints.geometry.attributes.position.needsUpdate = true; }
                cloudsGroup.children.forEach(p => { p.quaternion.copy(camera.quaternion); p.position.x += p.userData.speed; if(p.position.x > 750) p.position.x = -750; });
                if(currentWeather.isStorm && Math.random() > 0.985) { lightning.intensity = 5 + Math.random()*10; setTimeout(() => lightning.intensity = 0, 80); }
                renderer.render(scene, camera);
            }
            animate();
            window.addEventListener('resize', () => { camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
        }

        async function fetchWeather(lat, lon, name) {
            setLoading(true);
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);
                weatherData = await res.json(); updateStaticUI(name); updateFrame(0); updateChart(); updateDetailedForecast();
            } catch(e) { console.error(e); } finally { setLoading(false); }
        }

        function updateStaticUI(name) {
            document.getElementById('cityName').textContent = name;
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('windSpeed').textContent = `${weatherData.current.wind_speed_10m} km/h`;
            document.getElementById('humidity').textContent = `${weatherData.current.relative_humidity_2m} %`;
            const fc = document.getElementById('forecastContainerHome'); fc.innerHTML = '';
            for(let i=0; i<7; i++) { const d = new Date(weatherData.daily.time[i]); const div = document.createElement('div'); div.className = 'flex justify-between items-center mb-1 pb-1 border-b border-white/5'; div.innerHTML = `<span>${d.toLocaleDateString('fr-FR', {weekday:'short'})}</span><span class="text-blue-500 font-bold">${Math.round(weatherData.daily.temperature_2m_max[i])}°C</span>`; fc.appendChild(div); }
            lucide.createIcons();
        }

        function updateDetailedForecast() {
            const list = document.getElementById('detailedForecastList'); list.innerHTML = '';
            const d = weatherData.daily; const desc = getDescDict();
            for(let i=0; i<7; i++) {
                const date = new Date(d.time[i]); const item = document.createElement('div');
                item.className = 'glass-card flex flex-col md:flex-row justify-between items-center gap-4 hover:border-blue-500/50 transition-colors';
                item.innerHTML = `<div class="flex items-center gap-6"><div class="text-center w-24"><p class="text-xs uppercase font-black text-slate-500">${date.toLocaleDateString('fr-FR', {weekday:'short'})}</p><p class="text-2xl font-black">${date.getDate()}</p></div><div class="h-10 w-px bg-white/10 hidden md:block"></div><div><p class="font-bold text-lg">${desc[d.weather_code[i]] || 'Inconnu'}</p><p class="text-xs text-slate-400">Températures : ${Math.round(d.temperature_2m_min[i])}°C / ${Math.round(d.temperature_2m_max[i])}°C</p></div></div><div class="flex gap-4"><div class="bg-blue-600/20 px-4 py-2 rounded-xl text-center min-w-[100px]"><p class="text-[10px] uppercase font-bold text-blue-400">Maximum</p><p class="text-xl font-black">${Math.round(d.temperature_2m_max[i])}°C</p></div></div>`;
                list.appendChild(item);
            }
        }

        function getDescDict() {
            return { 0:'Ciel dégagé', 1:'Peu nuageux', 2:'Nuageux', 3:'Couvert', 45:'Brouillard', 48:'Brouillard givrant', 51:'Bruine légère', 53:'Bruine', 55:'Bruine forte', 61:'Pluie faible', 63:'Pluie', 65:'Pluie forte', 71:'Neige faible', 73:'Neige', 75:'Neige forte', 80:'Averses', 81:'Fortes averses', 82:'Averses violentes', 95:'Orage', 96:'Orage avec grêle', 99:'Orage violent' };
        }

        function updateFrame(idx) {
            if(!weatherData) return;
            const h = weatherData.hourly; const d = new Date(h.time[idx]); const hour = d.getHours(); const code = h.weather_code[idx];
            const isDay = hour >= 6 && hour <= 19; const curve = isDay ? Math.sin(((hour - 6) / 13) * Math.PI) : 0;
            let isCloudy = false, isOvercast = false, isRain = false, isSnow = false, isStorm = false, isFog = false;
            if (code >= 1 && code <= 2) isCloudy = true; if (code == 3) { isCloudy = true; isOvercast = true; } if (code == 45 || code == 48) { isCloudy = true; isFog = true; } if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) { isCloudy = true; isOvercast = true; isRain = true; } if ((code >= 71 && code <= 77) || code == 85 || code == 86) { isCloudy = true; isOvercast = true; isSnow = true; } if (code >= 95) { isCloudy = true; isOvercast = true; isRain = true; isStorm = true; }
            currentWeather = { isSnow, isRain, isStorm }; let cloudCoverTarget = 0.0;
            if (code == 1) cloudCoverTarget = 0.3; if (code == 2) cloudCoverTarget = 0.6; if (code == 3 || isOvercast || isFog) cloudCoverTarget = 1.0;
            let topColor = new THREE.Color(0x1e488f); let botColor = new THREE.Color(0x8cb4f5); let cloudColor = new THREE.Color(0xffffff);
            if (!isDay) { topColor.setHex(0x02040a); botColor.setHex(0x0a101d); cloudColor.setHex(0x111118); } else if (curve < 0.25) { topColor.setHex(0x2a3b60); botColor.setHex(0xff7744); cloudColor.setHex(0xffaa88); }
            if (isOvercast) { topColor.lerp(new THREE.Color(0x334155), 0.8); botColor.lerp(new THREE.Color(0x64748b), 0.8); cloudColor.lerp(new THREE.Color(isStorm ? 0x22222a : 0x777788), 0.9); }
            skyUniforms.uCloudCover.value = cloudCoverTarget; skyUniforms.uColorTop.value.copy(topColor); skyUniforms.uColorBottom.value.copy(botColor); skyUniforms.uCloudColor.value.copy(cloudColor);
            const angle = (hour / 24) * Math.PI * 2 - Math.PI/2; const radius = 200;
            sunSprite.position.set(Math.cos(angle)*radius, -Math.sin(angle)*radius, -100); moonMesh.position.set(Math.cos(angle + Math.PI)*radius, -Math.sin(angle + Math.PI)*radius, -100); sunLight.position.copy(sunSprite.position); sunLight.intensity = isDay && !isOvercast ? curve * 1.5 : (isDay ? curve * 0.4 : 0);
            let targetCloudOpacity = 0; if (code == 1) targetCloudOpacity = 0.3; if (code == 2) targetCloudOpacity = 0.6; if (code >= 3) targetCloudOpacity = 0.95; if (isFog) targetCloudOpacity = 0.2;
            cloudMat.opacity = targetCloudOpacity; cloudsGroup.visible = (targetCloudOpacity > 0); cloudMat.color.copy(cloudColor);
            stars.visible = !isDay && !isOvercast && !isFog; sunSprite.visible = isDay && !isOvercast && !isFog; moonMesh.visible = !isDay && !isOvercast && !isFog;
            rainLines.material.opacity = isRain ? (isStorm ? 0.7 : 0.4) : 0; snowPoints.material.opacity = isSnow ? 0.8 : 0;
            document.getElementById('sliderTimeLabel').textContent = d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}); document.getElementById('sliderDateLabel').textContent = d.toLocaleDateString('fr-FR', {day:'numeric', month:'short'}); document.getElementById('sliderTempLabel').textContent = `${Math.round(h.temperature_2m[idx])}°C`;
            const literalText = getDescDict()[code] || 'Instable'; document.getElementById('sliderDescLabel').textContent = literalText; document.getElementById('weatherLiteral').textContent = literalText;
        }

        function updateChart() {
            const ctx = document.getElementById('hourlyChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: weatherData.hourly.time.map(t => new Date(t).getHours() + 'h'), datasets: [{ data: weatherData.hourly.temperature_2m, borderColor: '#3b82f6', borderWidth: 3, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false } } });
        }

        async function triggerSearch(event) {
            if(event) event.preventDefault(); const val = input.value.trim(); if(!val) return; setLoading(true);
            try { const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=1&language=fr&format=json`); const data = await res.json(); if(data.results) { fetchWeather(data.results[0].latitude, data.results[0].longitude, data.results[0].name); input.blur(); } else { const st = document.getElementById('searchStatus'); st.style.opacity = 1; setTimeout(() => st.style.opacity = 0, 3000); } } catch(e) { console.error(e); } finally { setLoading(false); }
        }

        function setLoading(l) { const o = document.getElementById('loadingOverlay'); o.style.opacity = l ? 1 : 0; if(!l) setTimeout(() => o.classList.add('hidden'), 300); else o.classList.remove('hidden'); }
        function togglePlay() { isPlaying = !isPlaying; const btn = document.getElementById('playPauseBtn'); if (isPlaying) { btn.innerHTML = '<i data-lucide="pause" class="w-5 h-5"></i>'; btn.classList.replace('bg-blue-600', 'bg-red-500'); playInterval = setInterval(() => { let slider = document.getElementById('timeSlider'); let cv = parseInt(slider.value); cv++; if (cv > 167) cv = 0; slider.value = cv; updateFrame(cv); }, 800); } else { btn.innerHTML = '<i data-lucide="play" class="w-5 h-5 ml-0.5"></i>'; btn.classList.replace('bg-red-500', 'bg-blue-600'); clearInterval(playInterval); } lucide.createIcons(); }

        window.onload = () => { lucide.createIcons(); init3D(); fetchWeather(48.85, 2.35, "Paris"); document.getElementById('searchForm').addEventListener('submit', triggerSearch); document.getElementById('timeSlider').oninput = (e) => { if (isPlaying) togglePlay(); updateFrame(parseInt(e.target.value)); }; setTimeout(() => input.focus(), 500); };
    </script>
</body>
</html>
